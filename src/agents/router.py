"""
Input Router - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç LLM —Å strict structured output –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.
"""

import os
from typing import Dict, Any
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate

from ..state import InterviewState, RouterOutput


ROUTER_PROMPT = """–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é.

–í–û–ü–†–û–° –ò–ù–¢–ï–†–í–¨–Æ–ï–†–ê: {question}

–°–û–û–ë–©–ï–ù–ò–ï –ö–ê–ù–î–ò–î–ê–¢–ê: {message}

–ò–ù–¢–ï–ù–¢–´ (–≤—ã–±–µ—Ä–∏ –û–î–ò–ù):
- answer: –∫–∞–Ω–¥–∏–¥–∞—Ç –û–¢–í–ï–ß–ê–ï–¢ –Ω–∞ –≤–æ–ø—Ä–æ—Å (–ª—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å!)
- question: –∫–∞–Ω–¥–∏–¥–∞—Ç –ó–ê–î–ê–Å–¢ –≤—Å—Ç—Ä–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä—É
- off_topic: –∫–∞–Ω–¥–∏–¥–∞—Ç –≥–æ–≤–æ—Ä–∏—Ç –æ —á—ë–º-—Ç–æ –ö–ê–†–î–ò–ù–ê–õ–¨–ù–û –ù–ï –û–¢–ù–û–°–Ø–©–ï–ú–°–Ø –∫ –∏–Ω—Ç–µ—Ä–≤—å—é/—Ä–∞–±–æ—Ç–µ/—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º
- stop: –∫–∞–Ω–¥–∏–¥–∞—Ç —Ö–æ—á–µ—Ç –ó–ê–í–ï–†–®–ò–¢–¨ –∏–Ω—Ç–µ—Ä–≤—å—é (—Å—Ç–æ–ø, —Ö–≤–∞—Ç–∏—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∑–∞–∫–æ–Ω—á–∏–º)

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–£–¢–ê–ô:
- –ö–∞–Ω–¥–∏–¥–∞—Ç –≥–æ–≤–æ—Ä–∏—Ç –æ –°–ï–ë–ï, —Å–≤–æ—ë–º –û–ü–´–¢–ï, —Å–≤–æ–∏—Ö –ü–†–û–ï–ö–¢–ê–• ‚Üí answer (—ç—Ç–æ –æ—Ç–≤–µ—Ç!)
- –ö–∞–Ω–¥–∏–¥–∞—Ç –≥–æ–≤–æ—Ä–∏—Ç –æ –î–†–£–ì–û–ô —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (–Ω–µ —Ç–æ–π, —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∏) ‚Üí answer (—ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏!)
- –ö–∞–Ω–¥–∏–¥–∞—Ç —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ –†–ê–ë–û–¢–£, –ö–û–õ–õ–ï–ì, –ü–†–û–ï–ö–¢–´ ‚Üí answer (—ç—Ç–æ –ø—Ä–æ —Ä–∞–±–æ—Ç—É!)
- –ö–∞–Ω–¥–∏–¥–∞—Ç –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ –ü–û–ì–û–î–£, –ï–î–£, –û–¢–ü–£–°–ö, –õ–ò–ß–ù–û–ï (–Ω–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É) ‚Üí off_topic

–ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ –†–ê–ë–û–¢–£, –¢–ï–•–ù–û–õ–û–ì–ò–ò, –ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï, –û–ü–´–¢ ‚Äî —ç—Ç–æ answer!
–û—Ñ—Ñ—Ç–æ–ø–∏–∫ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ —á—Ç–æ-—Ç–æ –°–û–í–°–ï–ú –î–†–£–ì–û–ï (–ø–æ–≥–æ–¥–∞, –µ–¥–∞, –ª–∏—á–Ω–æ–µ –Ω–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É).

–ü–†–ò–ú–ï–†–´ answer:
- "–Ø —Ä–∞–±–æ—Ç–∞–ª —Å Django 3 –≥–æ–¥–∞" ‚Üí answer (–ø—Ä–æ –æ–ø—ã—Ç)
- "–Ø –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª Flask –≤–º–µ—Å—Ç–æ Django" ‚Üí answer (–ø—Ä–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)
- "–í –º–æ—ë–º –ø—Ä–æ–µ–∫—Ç–µ –±—ã–ª–æ —Ç–∞–∫..." ‚Üí answer (–ø—Ä–æ –ø—Ä–æ–µ–∫—Ç)
- "–Ø –Ω–µ –∑–Ω–∞—é, –Ω–æ –¥—É–º–∞—é..." ‚Üí answer (–ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å)
- "Django —ç—Ç–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫" (–Ω–µ–≤–µ—Ä–Ω–æ) ‚Üí answer (–æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å)

–ü–†–ò–ú–ï–†–´ off_topic:
- "–ö–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –ø–æ–≥–æ–¥–∞?" ‚Üí off_topic
- "–ß—Ç–æ –≤—ã –µ–ª–∏ –Ω–∞ –æ–±–µ–¥?" ‚Üí off_topic
- "–†–∞—Å—Å–∫–∞–∂—É –ø—Ä–æ —Å–≤–æ–π –æ—Ç–ø—É—Å–∫ –≤ –¢—É—Ä—Ü–∏–∏" ‚Üí off_topic
- "–ö–∞–∫ –≤–∞–º —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –º–∞—Ç—á –≤—á–µ—Ä–∞?" ‚Üí off_topic

–ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –õ–æ–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã (–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏) - —ç—Ç–æ answer, –Ω–æ –±–æ–ª–µ–µ —Å–µ—Ä—å—ë–∑–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.
–ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã Skeptic'–æ–º, –Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ answer.

–í—ã–±–µ—Ä–∏ intent –∏ –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫—É—é –º—ã—Å–ª—å (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ).
"""


def get_router_llm():
    """LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å strict structured output."""
    return ChatOpenAI(
        model=os.getenv("OPENAI_MODEL_FAST", "gpt-4o-mini"),
        temperature=0,
        reasoning_effort="minimal",
        max_completion_tokens=1000
    ).with_structured_output(RouterOutput)


def router_node(state: InterviewState) -> Dict[str, Any]:
    """
    –£–∑–µ–ª —Ä–æ—É—Ç–µ—Ä–∞ - –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ LLM.
    
    –ò–Ω—Ç–µ–Ω—Ç—ã:
    - answer: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç
    - question: –≤—Å—Ç—Ä–µ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    - off_topic: –æ—Ñ—Ñ—Ç–æ–ø
    - stop: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    """
    user_message = state.get("current_user_message", "")
    turn_id = state.get("turn_id", 0)
    
    # –ü–µ—Ä–≤—ã–π —Ö–æ–¥ ‚Äî –∫–∞–Ω–¥–∏–¥–∞—Ç –µ—â—ë –Ω–µ –æ—Ç–≤–µ—á–∞–ª
    if turn_id == 0 or not user_message:
        print(f"[Router] –ü–µ—Ä–≤—ã–π —Ö–æ–¥ (turn_id={turn_id}) ‚Äî –ø—Ä–æ–ø—É—Å–∫ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏")
        return {
            "user_intent": "answer",
            "next_step": "quick_respond",
            "router_thought": "–ü–µ—Ä–≤—ã–π —Ö–æ–¥ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å."
        }
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞ (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç)
    last_question = ""
    for msg in reversed(state.get("messages", [])):
        if msg["role"] == "assistant":
            last_question = msg["content"]
            break
    
    # LLM –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
    prompt = ChatPromptTemplate.from_template(ROUTER_PROMPT)
    llm = get_router_llm()
    chain = prompt | llm
    
    try:
        result: RouterOutput = chain.invoke({
            "question": last_question or "–ù–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤—å—é",
            "message": user_message
        })
        
        intent = result.intent
        internal_thought = result.internal_thought
        
        print(f"[Router] –ò–Ω—Ç–µ–Ω—Ç: {intent}")
        print(f"[Router] –ú—ã—Å–ª—å: {internal_thought}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
        if intent == "answer":
            next_step = "analyze"
        elif intent == "stop":
            next_step = "end"
        else:
            next_step = "quick_respond"
        
        return {
            "user_intent": intent,
            "next_step": next_step,
            "router_thought": internal_thought,
        }
        
    except Exception as e:
        print(f"[Router] –û—à–∏–±–∫–∞: {e}, fallback ‚Üí answer")
        return {
            "user_intent": "answer",
            "next_step": "analyze",
            "router_thought": f"–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {str(e)[:50]}, fallback –Ω–∞ answer"
        }

